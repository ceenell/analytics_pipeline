{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Template defining Athena resources for processing server logs",
  "Parameters": {
    "athenaDatabaseName": {
      "Type": "String",
      "Default": "athena_analytics_logs",
      "Description": "Name of the Athena database"
    }
  },
  "Resources": {
    "AnalyticsLogs": {
      "Type": "AWS::Glue::Database",
      "Properties": {
        "DatabaseInput": {
          "Description": "WMA server logs database",
          "Name": {"Ref": "athenaDatabaseName"}
        },
        "CatalogId": {"Ref":  "AWS::AccountId"}
      }
    },
    "WaterUsgsGovlogs": {
      "Type": "AWS::Glue::Table",
      "DependsOn": "AnalyticsLogs",
      "Properties": {
        "CatalogId": {"Ref":  "AWS::AccountId"},
        "DatabaseName": {"Ref": "athenaDatabaseName"},
        "TableInput": {
          "Description": "Table to waterdata.usgs.gov server logs from Parquet files",
          "Name": "waterdata_usgs_gov_parquet",
          "TableType": "EXTERNAL_TABLE",
          "Parameters": {
            "has_encrypted_data": "false"
          },
          "StorageDescriptor": {
            "OutputFormat": "org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat",
            "InputFormat": "org.apache.hadoop.mapred.TextInputFormat",
            "Location": "s3://wma-analytics-data/logs/waterdata.usgs.gov/parquet/",
            "Columns": [
              {"Name": "request_date_time", "Type": "string"},
              {"Name": "request_date_col", "Type": "date"},
              {"Name": "calendar_year", "Type": "smallint"},
              {"Name": "request_type", "Type": "string"},
              {"Name": "request_url", "Type": "string"},
              {"Name": "http_status", "Type": "int"},
              {"Name": "kbytes", "Type": "double"},
              {"Name": "referrer", "Type": "string"},
              {"Name": "ip_hash", "Type": "string"},
              {"Name": "ip_obscured", "Type": "string"},
              {"Name": "user_agent_simple", "Type": "string"},
              {"Name": "user_agent", "Type": "string"},
              {"Name": "host", "Type": "string"}
            ],
            "SerdeInfo": {
              "SerializationLibrary": "org.apache.hadoop.hive.ql.io.parquet.serde.ParquetHiveSerDe",
              "Parameters": {
                "has_encrypted_data": "false"
              }
            }
          }
        }
      }
    },
    "WaterservicesUsgsGovlogs": {
      "Type": "AWS::Glue::Table",
      "DependsOn": "AnalyticsLogs",
      "Properties": {
        "CatalogId": {"Ref":  "AWS::AccountId"},
        "DatabaseName": {"Ref": "athenaDatabaseName"},
        "TableInput": {
          "Description": "Table to hold waterservices.usgs.gov service logs from Parquet files",
          "Name": "waterservices_usgs_gov_parquet",
          "TableType": "EXTERNAL_TABLE",
          "Parameters": {
            "has_encrypted_data": "false"
          },
          "StorageDescriptor": {
            "OutputFormat": "org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat",
            "InputFormat": "org.apache.hadoop.mapred.TextInputFormat",
            "Location": "s3://wma-analytics-data/logs/waterservices.usgs.gov/parquet/",
            "Columns": [
              {"Name": "request_date_time", "Type": "string"},
              {"Name": "request_type", "Type": "string"},
              {"Name": "request_url", "Type": "string"},
              {"Name": "protocol", "Type": "string"},
              {"Name": "http_status", "Type": "int"},
              {"Name": "user_agent", "Type": "string"},
              {"Name": "kbytes", "Type": "double"},
              {"Name": "ip_hash", "Type": "string"},
              {"Name": "ip_obscured", "Type": "string"},
              {"Name": "user_agent_simple", "Type": "string"},
              {"Name": "request_date_col", "Type": "date"},
              {"Name": "calendar_year", "Type": "smallint"},
              {"Name": "host", "Type": "string"},
              {"Name": "ID", "Type": "int"},
              {"Name": "service", "Type": "string"},
              {"Name": "sites", "Type": "string"},
              {"Name": "format", "Type": "string"},
              {"Name": "startdt", "Type": "string"},
              {"Name": "enddt", "Type": "string"},
              {"Name": "sitestatus", "Type": "string"},
              {"Name": "parametercds", "Type": "string"},
              {"Name": "period", "Type": "string"},
              {"Name": "modifiedsince", "Type": "string"},
              {"Name": "access", "Type": "string"},
              {"Name": "statecd", "Type": "string"},
              {"Name": "indent", "Type": "string"},
              {"Name": "tsid", "Type": "string"},
              {"Name": "agencycd", "Type": "string"},
              {"Name": "seriescatalogoutput", "Type": "string"},
              {"Name": "siteoutput", "Type": "string"},
              {"Name": "sitetype", "Type": "string"},
              {"Name": "bbox", "Type": "string"}
            ],
            "SerdeInfo": {
              "SerializationLibrary": "org.apache.hadoop.hive.ql.io.parquet.serde.ParquetHiveSerDe",
              "Parameters": {
                "has_encrypted_data": "false"
              }
            }
          }
        }
      }
    }
  }
}